# 기능 명세서: 메디솔브AI 백엔드 전형 과제

**기능 브랜치**: `[001-medisolveai-backend-assignment]`  
**작성일**: 2025-11-06  
**상태**: 초안  
**입력**: 사용자 설명: "/prompts:speckit.specify 메디솔브에이아이의 백엔드 전형 과제를 도와줘 ..."

## 사용자 시나리오 및 테스트 *(필수)*

### 사용자 스토리 1 - 환자 예약 플로우 (우선순위: P1)

환자는 선호 의사와 진료 항목, 가능한 시간대를 선택해 예약을 생성하고 자신의 예약 내역을 확인·취소하고 싶다.

**우선순위 이유**: 환자 예약은 시스템의 핵심 가치 제공 기능이며 전체 서비스 가치의 기반이 된다.

**독립 테스트 방법**: `/api/v1/patient` 트리에 대한 통합 테스트로 예약 가능 시간 조회 → 예약 생성 → 조회/취소 흐름을 검증한다.

**인수 시나리오**:

1. **Given** 등록된 의사, 진료 항목, 병원 슬롯이 존재하고 **When** 환자가 가용 시간대로 예약을 생성하면 **Then** 예약이 `예약대기` 상태로 저장되고 초진/재진 판단이 기록된다.
2. **Given** 환자가 예약을 보유하고 **When** 환자 조회 API를 호출하면 **Then** 본인 예약만 상태와 함께 반환된다.
3. **Given** 환자가 예약을 보유하고 **When** 취소 API를 호출하면 **Then** 예약 상태가 `취소`로 갱신되고 이후 같은 시간대가 다시 노출된다.

---

### 사용자 스토리 2 - 관리자 운영 플로우 (우선순위: P1)

관리자는 의사, 병원 시간대, 진료 항목을 관리하고 예약 현황 및 통계를 확인하며 예약 상태를 변경하고 싶다.

**우선순위 이유**: 관리자 기능이 있어야 운영 정책(동시 수용 인원, 의사 편성 등)을 맞춰 환자 기능이 정상 동작한다.

**독립 테스트 방법**: `/api/v1/admin` 트리에 대한 통합 테스트로 CRUD, 예약 상태 변경, 통계 조회 시나리오를 검증한다.

**인수 시나리오**:

1. **Given** 관리자 자격으로 의사 생성 요청을 보내고 **When** CRUD 엔드포인트를 호출하면 **Then** 해당 의사 정보가 DB에 반영된다.
2. **Given** 여러 예약이 존재하고 **When** 관리자 예약 통계 API를 호출하면 **Then** 상태별/시간대별/초진-재진 비율이 정확한 수치로 반환된다.
3. **Given** 관리자가 예약 상태 변경 API를 호출하면 **Then** 상태 전이가 허용 순서를 따르고 잘못된 전이는 4xx로 거부된다.

---

### 사용자 스토리 3 - 시스템 운영자 및 DevOps (우선순위: P2)

운영자는 Docker Compose 한 번으로 전체 시스템을 기동하고, 마이그레이션이 자동 실행되며 테스트 명령으로 품질을 검증하고 싶다.

**우선순위 이유**: 배포 및 실행 편의성은 채점 환경 재현과 제출 완성도를 결정한다.

**독립 테스트 방법**: `docker-compose up`으로 서비스 기동 후 헬스체크, `pytest -q` 실행으로 환경 분리 검증 테스트를 수행한다.

**인수 시나리오**:

1. **Given** 프로젝트 의존성이 `uv`로 설치되고 **When** `docker-compose up`을 실행하면 **Then** DB 초기화가 완료된 뒤 게이트웨이/두 API가 기동된다.
2. **Given** 테스트 환경 변수가 주어지고 **When** `pytest -q`를 실행하면 **Then** 모듈 간 독립 테스트가 통과하며 프로덕션 설정을 건드리지 않는다.

---

### 사용자 스토리 4 - 알고리즘 평가 담당자 (우선순위: P2)

평가 담당자는 `Assignment2`의 난수 생성 로직을 독립적으로 실행하고, 테스트 및 보고서를 통해 구현 품질을 확인하고 싶다.

**우선순위 이유**: Task 2는 별도 채점 항목으로, API와 독립적인 실행 및 검증 경로가 필요하다.

**독립 테스트 방법**: `Assignment2/tests`에서 `pytest` 실행으로 통계적 분포 검증, 범위 검증 등을 수행하고 보고서 PDF 존재를 확인한다.

**인수 시나리오**:

1. **Given** `get_1_or_0` 함수가 정의되고 **When** 여러 번 호출하면 **Then** 0과 1이 균등하게(허용 오차 내) 반환된다.
2. **Given** `get_random(n)` 호출 시 **When** 충분한 반복 호출을 수행하면 **Then** 결과가 0 이상 n 이하 범위를 벗어나지 않으며 분포가 균등에 가깝다.
3. **Given** 테스트 스위트를 실행하면 **When** 다양한 n 값에 대해 케이스가 수행되고 **Then** 실패 사항 없이 통과한다.

---

### 에지 케이스

- 영업시간 경계(오픈 직후, 점심 시작/종료, 마감 직전)에 예약을 생성할 때 시간대 검증이 올바르게 동작하는가?
- 동일한 환자가 짧은 시간 안에 여러 예약을 시도할 때 중복/동시성 제약을 지키는가?
- 병원 슬롯 최대 인원수가 0 또는 매우 큰 값으로 설정될 때 정책이 안전하게 적용되는가?
- `get_random` 호출 시 n=0, n=1 등 최소 범위와 매우 큰 n에 대해 성능과 정확도가 유지되는가?
- DB 또는 외부 서비스 오류 시 API가 적절한 오류 응답 및 롤백을 제공하는가?

## 요구사항 *(필수)*

### 기능 요구사항

- **FR-001**: 시스템은 `Assignment1`에서 환자 예약 생성, 조회, 취소, 가능 시간 조회 API를 제공해야 한다.
- **FR-002**: 시스템은 관리자 전용 API를 통해 의사, 진료 항목, 병원 슬롯, 예약 상태, 통계를 CRUD/조회할 수 있어야 한다.
- **FR-003**: 예약 생성 로직은 15분 간격 시작, 30분 단위 슬롯 점유, 동시 수용 인원 제한을 모두 검증해야 한다.
- **FR-004**: 환자 초진/재진 여부는 완료된 예약 이력을 기준으로 자동 산출되어 Appointment에 저장되어야 한다.
- **FR-005**: `Assignment1` 전체는 Docker Compose로 게이트웨이(8000), Patient API(8001), Admin API(8002), RDB 컨테이너를 기동해야 한다.
- **FR-006**: `Assignment2`는 `get_1_or_0`, `get_random` 구현과 폭넓은 테스트, PDF 보고서를 포함해야 하며 FastAPI 의존성을 갖지 말아야 한다.
- **FR-007**: 프로젝트 루트에는 실행 방법과 AI 활용 내용을 담은 한글 README.md가 존재해야 한다.
- **FR-008**: 데이터베이스 스키마는 SQL 스크립트 또는 Alembic 마이그레이션으로 자동 초기화 가능해야 한다.
- **FR-009**: 환경 별 설정(`development`, `test`)을 분리하고 테스트는 독립 DB를 사용해야 한다.
- **FR-010**: pytest 기반 자동화 테스트는 환자/관리자 API 각각 최소 정상/예외 2건 이상을 포함해야 한다.

### 주요 엔터티

- **Doctor**: id, 이름, 진료과, 활성 여부, 생성/수정 일시.
- **Treatment**: id, 시술명, 소요시간(분: 30 단위), 가격, 설명, 활성 여부.
- **HospitalSlot**: id, 시간대 시작/종료(30분 단위), 최대 수용 인원, 우선순위 혹은 메모.
- **Patient**: id, 이름, 연락처, 선호 의사(optional), 생성/수정 일시.
- **Appointment**: id, patient_id, doctor_id, treatment_id, 예약 시작, 예약 종료, 상태, 초진/재진 플래그, 메모, 생성/수정 일시.
- **SystemConfig (선택)**: 병원 영업시간, 점심시간, 동시 진료 한도 등 정책 값 관리용 테이블 또는 환경 변수.

## 성공 기준 *(필수)*

### 측정 가능한 결과

- **SC-001**: `docker-compose up -d` 실행 후 2분 이내에 게이트웨이와 두 API 컨테이너가 모두 `healthy` 상태가 된다.
- **SC-002**: `pytest -q` 실행 시 환자/관리자 API 및 Assignment2 테스트 총 10건 이상이 통과하고 실패가 없다.
- **SC-003**: 환자 예약 생성 API 부하 테스트(동시 20요청)에서 p95 응답 시간이 200ms 이하를 유지한다(로컬 기준).
- **SC-004**: README를 따라 신규 개발자가 15분 이내에 환경 구성, 도커 실행, 기본 API 호출, 테스트 실행을 완료할 수 있다.
- **SC-005**: Assignment2 테스트는 `get_random(n)` 결과가 0~n 범위를 벗어나지 않음을 10,000회 시뮬레이션으로 검증하고 통과한다.

