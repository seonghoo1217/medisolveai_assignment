# 기능 명세서: 메디솔브AI 백엔드 과제

**기능 브랜치**: `001-medisolve-backend`  
**작성일**: 2025-11-06  
**상태**: 초안  
**입력**: 사용자 설명: "메디솔브에이아이의 백엔드 전형 과제를 도와줘"

## 사용자 시나리오 및 테스트 *(필수)*

### 사용자 스토리 1 - 환자 예약 플로우 (우선순위: P1)

환자는 선호 의사, 진료 항목, 가능한 시간대를 선택해 예약을 생성하고 자신의 예약 내역을 확인·취소하고 싶다.

**우선순위 이유**: 환자 예약은 서비스가 제공하는 핵심 가치이며 모든 후속 기능의 기반이다.

**독립 테스트 방법**: `환자 예약 가능 시간 조회 → 예약 생성 → 예약 조회 및 취소` 순으로 REST 통합 테스트를 수행하면 기능을 단독으로 검증할 수 있다.

**인수 시나리오**:

1. **Given** 의사, 진료 항목, 병원 슬롯이 준비되고 **When** 환자가 가용 시간대로 예약을 생성하면 **Then** 예약이 `예약대기` 상태로 저장되고 초진/재진 구분이 기록된다.
2. **Given** 환자가 여러 예약을 보유하고 **When** 환자 예약 조회 API를 호출하면 **Then** 본인 예약만 상태와 함께 반환된다.
3. **Given** 환자가 예약을 보유하고 **When** 취소 API를 호출하면 **Then** 예약 상태가 `취소`로 변경되고 해당 시간대가 다시 노출된다.

---

### 사용자 스토리 2 - 관리자 운영 플로우 (우선순위: P1)

관리자는 의사, 병원 슬롯, 진료 항목을 관리하고 예약 상태 및 통계를 통해 병원 운영을 통제하고 싶다.

**우선순위 이유**: 관리자 정책 설정이 있어야 환자 예약 정책이 안정적으로 작동하므로 최우선 기능이다.

**독립 테스트 방법**: `/api/v1/admin` 엔드포인트에 대한 CRUD 및 통계 통합 테스트를 작성해 운영 기능만으로도 가치를 검증할 수 있다.

**인수 시나리오**:

1. **Given** 관리자 자격으로 진료 항목 CRUD API를 호출하고 **When** 새로운 항목을 등록하면 **Then** 해당 항목이 목록 조회에 즉시 반영된다.
2. **Given** 여러 예약이 다양한 상태로 존재하고 **When** 통계 API를 호출하면 **Then** 상태별·시간대별·초진/재진 비율이 정확한 수치로 반환된다.
3. **Given** 관리자가 예약 상태 변경 API를 호출하면 **Then** `예약대기 → 확정 → 완료/취소` 순서만 허용되고 잘못된 전이는 거부된다.

---

### 사용자 스토리 3 - 운영 환경 기동 (우선순위: P2)

운영 담당자는 필요한 서비스를 한 번의 명령으로 기동하고, 자동 마이그레이션과 헬스체크를 통해 안정성을 확보하고 싶다.

**우선순위 이유**: 배포 및 실행 편의성은 평가 환경에서 기능을 검증할 수 있는 필수 조건이다.

**독립 테스트 방법**: Docker Compose 기동 후 게이트웨이와 각 서비스 헬스 엔드포인트를 점검하고, 실행일지에서 마이그레이션 성공 여부를 확인한다.

**인수 시나리오**:

1. **Given** 프로젝트 의존성이 준비되고 **When** 한 번의 명령으로 컨테이너를 띄우면 **Then** 데이터베이스 초기화 이후 게이트웨이와 두 API가 정상 기동된다.
2. **Given** 환경 변수를 `test`로 지정하고 **When** 자동화 테스트를 실행하면 **Then** 운영 설정을 변경하지 않고 독립 DB로 모든 테스트가 통과한다.

---

### 사용자 스토리 4 - 난수 생성 검증 (우선순위: P2)

평가 담당자는 `Assignment2` 난수 모듈을 독립적으로 실행하고 통계적 테스트 및 보고서를 통해 품질을 확인하고 싶다.

**우선순위 이유**: Task 2는 별도 평가 항목이므로 API와 분리된 검증 경로가 필수다.

**독립 테스트 방법**: 난수 모듈 단위 테스트에서 범위, 균등 분포, 경계값 시나리오를 실행하고 결과를 보고서에 반영한다.

**인수 시나리오**:

1. **Given** `get_1_or_0` 함수가 정의되어 있고 **When** 충분한 횟수로 호출하면 **Then** 0과 1이 허용 오차 내에서 균등하게 반환된다.
2. **Given** `get_random(n)` 함수를 여러 n 값으로 호출하면 **Then** 모든 결과가 0 이상 n 이하에 포함되고 분포 편향이 허용 오차 이내다.
3. **Given** 테스트 스위트를 실행하면 **Then** 통계 검증과 경계값 검사가 모두 통과하고 보고서에 요약된다.

---

### 에지 케이스

- 영업 시작 직전·점심 시간 전후·마감 직전 예약이 슬롯 검증을 통과하는지 확인한다.
- 동일 환자가 짧은 시간 내 연속 요청을 보낼 때 중복 예약 방지와 동시성 제약이 유지되는지 검증한다.
- 동일 시간대에 여러 환자가 동시에 예약을 요청할 경우 트랜잭션 경합이 발생하지 않고 일관된 결과가 저장되는지 검증한다.
- 병원 슬롯 최대 인원수가 0 또는 큰 값으로 설정될 때 정책이 안전하게 적용되는지 확인한다.
- 데이터베이스 장애나 타임아웃이 발생할 때 API가 일관된 오류 응답과 롤백을 제공하는지 확인한다.
- `get_random` 호출에서 n=0, n=1, 매우 큰 n 값이 모두 성능·정확도 기준을 만족하는지 검증한다.

## 요구사항 *(필수)*

### 기능 요구사항

- **FR-001**: 시스템은 환자용 API에서 예약 생성, 조회, 취소, 가능 시간 조회 기능을 제공해야 한다.
- **FR-002**: 시스템은 관리자용 API에서 의사, 진료 항목, 병원 슬롯, 예약 상태, 통계를 CRUD/조회할 수 있어야 한다.
- **FR-003**: 예약 생성 로직은 15분 간격 시작, 30분 단위 슬롯 점유, 동시 수용 인원 제한을 모두 검증해야 한다.
- **FR-004**: 환자 초진/재진 여부는 완료된 예약 이력을 기준으로 자동 산출되어 Appointment에 저장되어야 한다.
- **FR-005**: 동일 의사·시간대 중복 예약을 방지하기 위해 데이터베이스 차원에서 `(doctor_id, 예약 시작)` 또는 실제 점유 슬롯 조합에 대한 유니크 제약을 둔다.
- **FR-006**: 프로젝트 루트에는 실행 방법과 AI 활용 기록을 포함한 한글 README.md가 존재해야 한다.
- **FR-007**: 데이터베이스 스키마는 SQL 스크립트 또는 Alembic 마이그레이션으로 자동 초기화 가능해야 한다.
- **FR-008**: Docker Compose는 게이트웨이(8000), 환자 API(8001), 관리자 API(8002), 단일 관계형 DB 컨테이너를 기동해야 한다.
- **FR-009**: `Assignment1`과 `Assignment2`는 독립 실행 진입점을 유지하고 런타임 의존성을 공유하지 않아야 한다.
- **FR-010**: 자동화 테스트는 환자·관리자 API와 난수 모듈 각각에 대해 정상/예외 최소 2건 이상의 시나리오를 포함해야 한다.
- **FR-011**: 예약 생성 및 상태 변경 API는 경쟁 상태를 방지하기 위해 트랜잭션 락 또는 큐잉 전략으로 다중 요청을 안전하게 처리해야 한다.

### 주요 엔터티

- **Doctor**: id, 이름(유니크), 진료과, 활성 여부, 생성/수정 일시.
- **Treatment**: id, 시술명(유니크), 소요 시간(분·30 단위), 가격, 설명, 활성 여부.
- **HospitalSlot**: id, 시간대 시작·종료(30분 단위) 복합 유니크, 최대 수용 인원, 메모.
- **Patient**: id, 이름, 연락처(유니크), 선호 의사(optional), 생성/수정 일시.
- **Appointment**: id, patient_id, doctor_id, treatment_id, 예약 시작, 예약 종료, 상태, 초진/재진 플래그, 메모, 생성/수정 일시, 점유 슬롯 기록.
- **SystemConfig(선택)**: 병원 영업시간, 점심시간, 동시 진료 한도 등 정책 값 관리.

## 가정

- 병원은 월요일부터 금요일까지 동일한 영업시간을 사용하며, 주말 휴무로 간주한다.
- 예약 가능 시간대는 한국 표준시(KST)를 기준으로 관리한다.
- 관리자 인증·권한 관리는 과제 범위를 벗어난다고 가정하고 내부 네트워크에서만 호출한다고 본다.
- 예약 생성 트랜잭션은 비관적 락 또는 재시도 가능한 낙관적 락을 적용해 경쟁 조건을 완화한다고 가정한다.
- `Assignment2`의 PDF 보고서는 저장소 내 `Assignment2/reports/` 경로에 배치한다.

## 성공 기준 *(필수)*

### 측정 가능한 결과

- **SC-001**: 한 번의 실행 명령으로 모든 컨테이너가 2분 이내 정상 기동하고 헬스 체크를 통과한다.
- **SC-002**: 전체 자동화 테스트를 한 번 실행하면 환자/관리자 API와 난수 모듈 시나리오 10건 이상이 모두 통과한다.
- **SC-003**: 환자 예약 생성 API에 대해 동시 20건 요청을 가했을 때 95번째 백분위 응답 시간이 0.2초 이하로 유지된다.
- **SC-004**: README 절차를 따라 새 환경을 구성한 사용자가 15분 이내 예약 생성과 취소 흐름을 재현할 수 있다.
- **SC-005**: 난수 생성 테스트는 10,000회 시뮬레이션에서 0~n 범위를 벗어난 결과가 0건임을 증명하고 보고서에 기록한다.
